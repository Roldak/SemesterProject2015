\section{Redesigning MbArrays}
\label{sec:redesign}

After having exposed the flow in the current |MbArray| design that slows down its performance, I will present the approach I took in order to address it.

\subsection{The Goal}

Ultimately, the goal is to keep the mechanisms in |MbArray|s that are working, but to decrease the memory needed for that.
To this end, the design change I opted for was adding more specializations to the |MbArray|s: one for each primitive type that exists in Scala. In other words, an |MbArray[Boolean]| would get transformed to |MbArray_B| which uses a |boolean[]| internally instead of the prevous |long[]|, and so on equivalently for every of the 10 primitive types that exist in Scala. Hopefully, this would result in less heap memory wasted and therefore a higher GC throughput.

\subsection{Design transformation}

Adding the 8 other specializations was fairly straightforward: All that had to be done was duplicating one of the two existing specialization for every new variants and changing the internal array type |Array[Long]| to the ones adapted for the different specialization.
Then, the code that handled |MbArray| instantiations, namely |MbArray_empty_J|, |MbArray_empty_D|, |MbArray_clone_J| and |MbArray_clone_D|, had to be modified in order to take into accounts the new specializations.
For example:

\begin{lstlisting-nobreak-java}
public static <T> MbArray<T> mbArray_empty_J(int size, byte T_Tag) {
  return new MbArray_J<T>(T_Tag, size);
}
\end{lstlisting-nobreak-java}

Was transformed to:

\begin{lstlisting-nobreak-java}
public static <T> MbArray<T> mbArray_empty_J(int size, byte T_Tag) {
  switch(T_Tag) {
  case MiniboxConstants.LONG:
    return new MbArray_J<T>(size);
  case MiniboxConstants.INT:
    return new MbArray_I<T>(size);
  case MiniboxConstants.SHORT:
    return new MbArray_S<T>(size);
  case MiniboxConstants.CHAR:
    return new MbArray_C<T>(size);
  case MiniboxConstants.BYTE:
    return new MbArray_B<T>(size);
  case MiniboxConstants.BOOLEAN:
    return new MbArray_Z<T>(size);
  case MiniboxConstants.UNIT:
    return new MbArray_V<T>(size);
  default:
    return new MbArray_L<T>(size);
  }
}
\end{lstlisting-nobreak-java}

Similarly, the |apply| and |update| methods had to be changed.
For example:

\begin{lstlisting-nobreak-java}
public static <T> long mbArray_apply_J(MbArray<T> mbArray, int index, byte T_Tag) {
  if (mbArray instanceof MbArray_J<?>)
    return ((MbArray_J<?>)mbArray).apply_J(index);
  else
    return MiniboxConversionsLong.box2minibox_tt(
    	mbArray.apply(index), T_Tag);
}
\end{lstlisting-nobreak-java}

Became:

\begin{lstlisting-nobreak-java}
public static <T> long mbArray_apply_J(MbArray<T> mbArray, int index, byte T_Tag) {
  if (mbArray instanceof MbArray_J<?>)
    return ((MbArray_J<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_I<?>)
    return ((MbArray_I<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_S<?>)
    return ((MbArray_S<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_C<?>)
    return ((MbArray_C<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_B<?>)
    return ((MbArray_B<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_Z<?>)
    return ((MbArray_Z<?>)mbArray).apply_J(index);
  else if (mbArray instanceof MbArray_V<?>)
    return ((MbArray_V<?>)mbArray).apply_J(index);
  else
    return MiniboxConversionsLong.<T>box2minibox_tt(
    	mbArray.apply(index), T_Tag);
}
\end{lstlisting-nobreak-java}

\subsection{Re-benchmarking}

It is now time to compare the old numbers to the numbers we obtain by running the same benchmark with the new |MbArray|. Figure \ref{fig:NewCTvsMB} shows that the new version performs approximately at the same level as the |ClassTag| version on this benchmark. Moreover, figure \ref{fig:NewGcComp} shows how the new version spends |~|3 times less time collecting garbage than the old version, from which follows a |~100ms| runtime performance gain. One can note that one top of the gain coming from the reduced amount of time spent collecting garbage, the new version gets a boost of |~70ms| for other reasons. In average, the new version is $25\%$ faster than the old version in this benchmark.

\begin{figure}
\subfigure[ClassTag version]{
	\lstinputlisting{BenchmarkOutputs/CtVector0.txt}	
	\label{fig:CtVector0}
}
\subfigure[Old Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/MbVector0.txt}
    \label{fig:MbVector0}
}
\subfigure[New Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/NewMbVector0.txt}
    \label{fig:NewMbVector0}
}
\caption{New Scalameter benchmark outputs}
\label{fig:NewCTvsMB}
\end{figure}  

\begin{figure}
\subfigure[ClassTag version]{
	\lstinputlisting{BenchmarkOutputs/CtVector1.txt}
	\label{fig:CtVector1}
}
\subfigure[Old Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/MbVector1.txt}
    \label{fig:MbVector1}
}
\subfigure[New Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/NewMbVector1.txt}
    \label{fig:NewMbVector1}
}
\caption{New benchmark outputs for ArrayBuffers of 10'000'000 elements}
\label{fig:NewGcComp}
\end{figure}

Looking at the initial benchmark, even the new |MbArray| version does not seem to be a lot faster than the |ClassTag| version. However, most of the benchmark \emph{do} show better numbers for the new |MbArray|. For example, benchmark \ref{fig:OtherCTvsMB} shows that the version using new |MbArray|s can be approximately $250\%$ faster than the version using |ClassTag|s and $20\%$ faster than the version using the old |MbArray|s. Also, figure \ref{fig:OtherGcComp} shows how the version using new |MbArray|s spends approximately $650\%$ less time collecting garbage. Note that the only difference in the source code between this benchmark and the initial one is that instead of:

\begin{lstlisting-nobreak}
  using(vectors) setUp {
    v => 
      v.map(_ + 1)
      v.map(_ + 2)
  } in {
    v => v.map(_ + 1).map(_ + 2).map(_ + 3)
  }
\end{lstlisting-nobreak}

It is doing : 

\begin{lstlisting-nobreak}
  using(vectors) setUp {
    v => 
      v.map(_ + 1)
      v.map(_ + 2)
  } in {
    v => v.map(_ + 1).map(_ + 2.5f).map(_ + 3)
  }
\end{lstlisting-nobreak}

It is worth noting that the speed factor increases when less memory is assigned to the JVM. For example, running the benchmark on a JVM which disposes of less than $400M$ completely crashes the version using the old |MbArray|s by throwing an |OutOfMemory| exception. While the amount of memory assigned is between $400M$ and $512M$, the old |MbArray| version performs really bad compared to the two other versions. Finally, when more than $512M$ is assigned, we obtain the numbers that have been shown so far: in every benchmark, the JVM was allowed to allocated up to $2G$.

\subsection{Conclusion}

In almost every cases, the version using new |MbArray|s is faster than the version using old |MbArray|s. Futhermore, although it is in some cases running as equivalently fast as the |ClassTag| version -- as shows benchmark \ref{fig:NewCTvsMB} --, it is actually in most cases faster than the |ClassTag| version, benchmark \ref{fig:OtherCTvsMB} being a good example of this. 

\begin{figure}
\subfigure[ClassTag version]{
	\lstinputlisting{BenchmarkOutputs/CtVector2.txt}	
	\label{fig:CtVector0}
}
\subfigure[Old Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/MbVector2.txt}
    \label{fig:MbVector0}
}
\subfigure[New Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/NewMbVector2.txt}
    \label{fig:NewMbVector0}
}
\caption{Scalameter benchmark outputs. Using map(\_ + 2.5f) instead of map(\_ + 2)}
\label{fig:OtherCTvsMB}
\end{figure}

\begin{figure}
\subfigure[ClassTag version]{
	\lstinputlisting{BenchmarkOutputs/CtVector3.txt}
	\label{fig:CtVector1}
}
\subfigure[Old Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/MbVector3.txt}
    \label{fig:MbVector1}
}
\subfigure[New Miniboxed version]{
	\lstinputlisting{BenchmarkOutputs/NewMbVector3.txt}
    \label{fig:NewMbVector1}
}
\caption{New benchmark outputs for ArrayBuffers of 10'000'000 elements using map(\_ + 2.5f) instead of map(\_ + 2)}
\label{fig:OtherGcComp}
\end{figure}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sed dictum felis. Maecenas in neque viverra, iaculis augue facilisis, ornare risus. Phasellus sollicitudin tempus tempor. Suspendisse vel velit eget urna ullamcorper congue. Mauris et tellus at tortor tempor blandit. Nam cursus lorem id arcu consequat fermentum. Nullam quis mi et lacus placerat tempor. Vestibulum gravida eu dui sed condimentum.

Duis mattis rutrum magna, nec venenatis justo vehicula sed. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur vitae risus diam. Suspendisse in iaculis lorem. In mattis laoreet posuere. Integer ac lacus libero. Nunc vehicula, mauris vestibulum vestibulum imperdiet, orci massa vestibulum sapien, sed maximus ante velit varius dui. Cras nec mauris facilisis, mattis mi id, auctor massa. Fusce volutpat maximus sapien, luctus posuere tortor. Aliquam erat volutpat. Suspendisse est ante, porta quis tempus non, fringilla fringilla ligula. Nulla luctus a lorem at cursus. Aenean ac dolor ac arcu interdum malesuada a vel sapien.

Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Vestibulum lorem urna, tristique eget massa a, molestie aliquam neque. Suspendisse at interdum nunc, sit amet tincidunt tortor. Pellentesque a mauris auctor, dictum libero sit amet, blandit sem. Nulla facilisi. In eget ultrices nulla. Fusce suscipit aliquam ex, id ultrices nisl interdum nec. Pellentesque aliquam lorem eu velit consequat congue. Aliquam facilisis, odio eget faucibus dignissim, eros magna ullamcorper lectus, vitae molestie felis neque sit amet lectus. Integer mollis lectus facilisis, congue nulla venenatis, varius magna.

Maecenas vitae interdum orci. Donec suscipit lacinia nibh, vitae vestibulum velit commodo non. Etiam ac arcu blandit quam bibendum luctus quis ac sapien. Duis vitae enim iaculis, scelerisque magna quis, imperdiet risus. Fusce faucibus a dolor quis malesuada. Duis aliquam, ipsum in interdum iaculis, libero dui tincidunt quam, ut sodales sapien turpis sed tellus. Maecenas consectetur mi ac erat imperdiet auctor. Curabitur congue augue et gravida iaculis. In ultricies augue id orci mattis venenatis a nec est. Mauris fringilla tempor mattis.

Curabitur eleifend pellentesque tellus. In vehicula placerat lacinia. Proin ut scelerisque quam, ac maximus diam. Sed cursus mauris eget porta blandit. Vestibulum a dolor sit amet eros molestie tincidunt sed eget mi. Nunc sit amet diam nulla. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 	


Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sed dictum felis. Maecenas in neque viverra, iaculis augue facilisis, ornare risus. Phasellus sollicitudin tempus tempor. Suspendisse vel velit eget urna ullamcorper congue. Mauris et tellus at tortor tempor blandit. Nam cursus lorem id arcu consequat fermentum. Nullam quis mi et lacus placerat tempor. Vestibulum gravida eu dui sed condimentum.

Duis mattis rutrum magna, nec venenatis justo vehicula sed. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur vitae risus diam. Suspendisse in iaculis lorem. In mattis laoreet posuere. Integer ac lacus libero. Nunc vehicula, mauris vestibulum vestibulum imperdiet, orci massa vestibulum sapien, sed maximus ante velit varius dui. Cras nec mauris facilisis, mattis mi id, auctor massa. Fusce volutpat maximus sapien, luctus posuere tortor. Aliquam erat volutpat. Suspendisse est ante, porta quis tempus non, fringilla fringilla ligula. Nulla luctus a lorem at cursus. Aenean ac dolor ac arcu interdum malesuada a vel sapien.

Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Vestibulum lorem urna, tristique eget massa a, molestie aliquam neque. Suspendisse at interdum nunc, sit amet tincidunt tortor. Pellentesque a mauris auctor, dictum libero sit amet, blandit sem. Nulla facilisi. In eget ultrices nulla. Fusce suscipit aliquam ex, id ultrices nisl interdum nec. Pellentesque aliquam lorem eu velit consequat congue. Aliquam facilisis, odio eget faucibus dignissim, eros magna ullamcorper lectus, vitae molestie felis neque sit amet lectus. Integer mollis lectus facilisis, congue nulla venenatis, varius magna.

Maecenas vitae interdum orci. Donec suscipit lacinia nibh, vitae vestibulum velit commodo non. Etiam ac arcu blandit quam bibendum luctus quis ac sapien. Duis vitae enim iaculis, scelerisque magna quis, imperdiet risus. Fusce faucibus a dolor quis malesuada. Duis aliquam, ipsum in interdum iaculis, libero dui tincidunt quam, ut sodales sapien turpis sed tellus. Maecenas consectetur mi ac erat imperdiet auctor. Curabitur congue augue et gravida iaculis. In ultricies augue id orci mattis venenatis a nec est. Mauris fringilla tempor mattis.

Curabitur eleifend pellentesque tellus. In vehicula placerat lacinia. Proin ut scelerisque quam, ac maximus diam. Sed cursus mauris eget porta blandit. Vestibulum a dolor sit amet eros molestie tincidunt sed eget mi. Nunc sit amet diam nulla. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 